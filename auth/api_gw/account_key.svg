<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="589px" preserveAspectRatio="none" style="width:908px;height:589px;background:#FFFFFF;" version="1.1" viewBox="0 0 908 589" width="908px" zoomAndPan="magnify"><defs><filter height="300%" id="f1qkgpt4hl6bf7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1qkgpt4hl6bf7)" height="300.0605" style="stroke:#000000;stroke-width:2.0;" width="747" x="147" y="113.7988"/><rect fill="#FFFFFF" filter="url(#f1qkgpt4hl6bf7)" height="105.2422" style="stroke:#000000;stroke-width:2.0;" width="727" x="157" y="167.4199"/><rect fill="#FFFFFF" height="134.1973" style="stroke:none;stroke-width:1.0;" width="747" x="147" y="279.6621"/><rect fill="#FFFFFF" filter="url(#f1qkgpt4hl6bf7)" height="75.9316" style="stroke:#000000;stroke-width:2.0;" width="579" x="157" y="330.9277"/><rect fill="#FFFFFF" filter="url(#f1qkgpt4hl6bf7)" height="46.6211" style="stroke:#000000;stroke-width:2.0;" width="336" x="157" y="457.1699"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="34" x2="34" y1="67.4883" y2="520.791"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="207" x2="207" y1="67.4883" y2="520.791"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="391" x2="391" y1="67.4883" y2="520.791"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="525" x2="525" y1="67.4883" y2="520.791"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="646" x2="646" y1="67.4883" y2="520.791"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="805" x2="805" y1="67.4883" y2="520.791"/><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="54" x="5" y="32"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="12" y="52.5352">Client</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="54" x="5" y="519.791"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="12" y="540.3262">Client</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="76" x="167" y="32"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="174" y="52.5352">Auth_API</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="76" x="167" y="519.791"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="174" y="540.3262">Auth_API</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="180" x="299" y="32"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="306" y="52.5352">Maintain_Consumer_API</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="180" x="299" y="519.791"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="306" y="540.3262">Maintain_Consumer_API</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="493" y="64.5352">Auth_DB</text><path d="M507,15 C507,5 525,5 525,5 C525,5 543,5 543,15 L543,41 C543,51 525,51 525,51 C525,51 507,51 507,41 L507,15 " fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" style="stroke:#000000;stroke-width:1.5;"/><path d="M507,15 C507,25 525,25 525,25 C525,25 543,25 543,15 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="493" y="533.3262">Auth_DB</text><path d="M507,546.2793 C507,536.2793 525,536.2793 525,536.2793 C525,536.2793 543,536.2793 543,546.2793 L543,572.2793 C543,582.2793 525,582.2793 525,582.2793 C525,582.2793 507,582.2793 507,572.2793 L507,546.2793 " fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" style="stroke:#000000;stroke-width:1.5;"/><path d="M507,546.2793 C507,556.2793 525,556.2793 525,556.2793 C525,556.2793 543,556.2793 543,546.2793 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="155" x="567" y="32"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="574" y="52.5352">Keycloak_Admin_API</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="155" x="567" y="519.791"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="141" x="574" y="540.3262">Keycloak_Admin_API</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="134" x="736" y="32"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="743" y="52.5352">Pay_Sandbox_API</text><rect fill="#FEFECE" filter="url(#f1qkgpt4hl6bf7)" height="30.4883" style="stroke:#A80036;stroke-width:1.5;" width="134" x="736" y="519.791"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="743" y="540.3262">Pay_Sandbox_API</text><polygon fill="#A80036" points="195,94.7988,205,98.7988,195,102.7988,199,98.7988" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="34" x2="201" y1="98.7988" y2="98.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="41" y="94.0566">/orgs/:org_id/api-keys</text><path d="M147,113.7988 L209,113.7988 L209,120.7988 L199,130.7988 L147,130.7988 L147,113.7988 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="300.0605" style="stroke:#000000;stroke-width:2.0;" width="747" x="147" y="113.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="162" y="127.3672">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="155" x="224" y="126.4336">[If Sandbox Key Generation]</text><polygon fill="#A80036" points="379,148.4199,389,152.4199,379,156.4199,383,152.4199" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="385" y1="152.4199" y2="152.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="214" y="147.6777">Check if consumer exists</text><path d="M157,167.4199 L219,167.4199 L219,174.4199 L209,184.4199 L157,184.4199 L157,167.4199 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="105.2422" style="stroke:#000000;stroke-width:2.0;" width="727" x="157" y="167.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="172" y="180.9883">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="150" x="234" y="180.0547">[If consumer doesn't exist]</text><polygon fill="#A80036" points="793,202.041,803,206.041,793,210.041,797,206.041" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="799" y1="206.041" y2="206.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="214" x="214" y="201.2988">Create sandbox payment account.</text><polygon fill="#A80036" points="634.5,231.3516,644.5,235.3516,634.5,239.3516,638.5,235.3516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="640.5" y1="235.3516" y2="235.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="361" x="214" y="230.6094">Create a keycloak client and add to sandbox_users group</text><polygon fill="#A80036" points="379,260.6621,389,264.6621,379,268.6621,383,264.6621" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="385" y1="264.6621" y2="264.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="214" y="259.9199">Create a consumer</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="147" x2="894" y1="280.6621" y2="280.6621"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="142" x="152" y="291.2969">[If PROD Key Generation]</text><polygon fill="#A80036" points="379,311.9277,389,315.9277,379,319.9277,383,315.9277" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="385" y1="315.9277" y2="315.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="214" y="311.1855">Check if consumer exists</text><path d="M157,330.9277 L219,330.9277 L219,337.9277 L209,347.9277 L157,347.9277 L157,330.9277 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="75.9316" style="stroke:#000000;stroke-width:2.0;" width="579" x="157" y="330.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="172" y="344.4961">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="150" x="234" y="343.5625">[If consumer doesn't exist]</text><polygon fill="#A80036" points="634.5,365.5488,644.5,369.5488,634.5,373.5488,638.5,369.5488" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="640.5" y1="369.5488" y2="369.5488"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="326" x="214" y="364.8066">Create a keycloak client and add to api_users group</text><polygon fill="#A80036" points="379,394.8594,389,398.8594,379,402.8594,383,398.8594" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="385" y1="398.8594" y2="398.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="214" y="394.1172">Create a consumer</text><polygon fill="#A80036" points="513,438.1699,523,442.1699,513,446.1699,517,442.1699" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="519" y1="442.1699" y2="442.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="214" y="437.4277">Update has_api status</text><path d="M157,457.1699 L219,457.1699 L219,464.1699 L209,474.1699 L157,474.1699 L157,457.1699 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="46.6211" style="stroke:#000000;stroke-width:2.0;" width="336" x="157" y="457.1699"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="17" x="172" y="470.7383">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="165" x="234" y="469.8047">[If additional Key Generation]</text><polygon fill="#A80036" points="379,491.791,389,495.791,379,499.791,383,495.791" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="207" x2="385" y1="495.791" y2="495.791"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="214" y="491.0488">Create a new key</text><!--MD5=[f003730cc5aed0b7eee2336aebc9b3be]
@startuml api_gw/account_key

participant Client
participant Auth_API
participant Maintain_Consumer_API
database    Auth_DB
participant Keycloak_Admin_API
participant Pay_Sandbox_API

Client -> Auth_API: /orgs/:org_id/api-keys
alt If Sandbox Key Generation
    Auth_API -> Maintain_Consumer_API:  Check if consumer exists
    alt If consumer doesn't exist
        Auth_API -> Pay_Sandbox_API : Create sandbox payment account.
        Auth_API -> Keycloak_Admin_API : Create a keycloak client and add to sandbox_users group
        Auth_API -> Maintain_Consumer_API: Create a consumer
    end
else If PROD Key Generation
    Auth_API -> Maintain_Consumer_API:  Check if consumer exists
    alt If consumer doesn't exist
        Auth_API -> Keycloak_Admin_API : Create a keycloak client and add to api_users group
        Auth_API -> Maintain_Consumer_API: Create a consumer
    end
end
Auth_API -> Auth_DB : Update has_api status
alt If additional Key Generation
    Auth_API -> Maintain_Consumer_API:  Create a new key
end
@enduml

PlantUML version 1.2021.14(Fri Nov 12 08:46:50 PST 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: CA
--></g></svg>